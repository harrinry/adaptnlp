---

title: Tutorial&#58; Fine-Tuning Sequence Classification on HuggingFace `Datasets` with MRPC


keywords: fastai
sidebar: home_sidebar

summary: "Tuning a Sequence Classification model on the Microsoft MRPC dataset"
description: "Tuning a Sequence Classification model on the Microsoft MRPC dataset"
nb_path: "nbs/training_api_tutorials/sequence_classification/sequence_classification_from_datasets.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/training_api_tutorials/sequence_classification/sequence_classification_from_datasets.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction"> </a></h2><p>In this tutorial we will be showing an end-to-end example of fine-tuning a Transformer for sequence classification on a custom dataset in HuggingFace <code>Dataset</code> format.</p>
<p>By the end of this you should be able to:</p>
<ol>
<li>Build a dataset with the <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> class, and their DataLoaders</li>
<li>Build a <a href="/adaptnlp/training.sequence_classification.html#SequenceClassificationTuner"><code>SequenceClassificationTuner</code></a> quickly, find a good learning rate, and train with the One-Cycle Policy</li>
<li>Save that model away, to be used with deployment or other HuggingFace libraries</li>
<li>Apply inference using both the <code>Tuner</code> available function as well as with the <a href="/adaptnlp/sequence_classification.html#EasySequenceClassifier"><code>EasySequenceClassifier</code></a> class within AdaptNLP</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Installing-the-Library">Installing the Library<a class="anchor-link" href="#Installing-the-Library"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This tutorial utilizies the latest AdaptNLP version, as well as parts of the <code>fastai</code> library. Please run the below code to install them:</p>
<div class="highlight"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">adaptnlp</span> <span class="o">-</span><span class="n">U</span>
</pre></div>
<p>(or <code>pip3</code>)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-the-Dataset">Getting the Dataset<a class="anchor-link" href="#Getting-the-Dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we need a dataset. We will use <code>dataset</code>'s <code>load_dataset</code> function to quickly generate a raw dataset straight from HuggingFace:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="s2">&quot;mrpc&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset glue (/root/.cache/huggingface/datasets/glue/mrpc/1.0.0/dacbe3125aa31d7f70367a07a8a9e72a5a0bfeb5fc42e75c9db75b96da6053ad)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now have a raw <code>datasets</code> dataset, which we can index into:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;idx&#39;: 0,
 &#39;label&#39;: 1,
 &#39;sentence1&#39;: &#39;Amrozi accused his brother , whom he called &#34; the witness &#34; , of deliberately distorting his evidence .&#39;,
 &#39;sentence2&#39;: &#39;Referring to him as only &#34; the witness &#34; , Amrozi accused his brother of deliberately distorting his evidence .&#39;}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the data downloaded, let's decide on a model to use.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Picking-a-Model-with-the-Hub">Picking a Model with the Hub<a class="anchor-link" href="#Picking-a-Model-with-the-Hub"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>AdaptNLP has a <a href="/adaptnlp/model_hub.html#HFModelHub"><code>HFModelHub</code></a> class that allows you to communicate with the HuggingFace Hub and pick a model from it, as well as a namespace <code>HF_TASKS</code> class with a list of valid tasks we can search by.</p>
<p>Let's try and find one suitable for sequence classification.</p>
<p>First we need to import the class and generate an instance of it:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">HFModelHub</span><span class="p">,</span> <span class="n">HF_TASKS</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hub</span> <span class="o">=</span> <span class="n">HFModelHub</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we can search for a model:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">search_model_by_task</span><span class="p">(</span><span class="n">HF_TASKS</span><span class="o">.</span><span class="n">TEXT_CLASSIFICATION</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's look at a few:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Model Name: distilbert-base-uncased-finetuned-sst-2-english, Tasks: [text-classification],
 Model Name: roberta-base-openai-detector, Tasks: [text-classification],
 Model Name: roberta-large-mnli, Tasks: [text-classification],
 Model Name: roberta-large-openai-detector, Tasks: [text-classification]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>These are models specifically tagged with the <code>text-classification</code> tag, so you may not see a few models you would expect such as <code>bert_base_cased</code>.</p>
<p>Let's search for that one for this problem:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">search_model_by_name</span><span class="p">(</span><span class="s1">&#39;bert-base-uncased&#39;</span><span class="p">,</span> <span class="n">user_uploaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Model Name: bert-base-uncased, Tasks: [fill-mask],
 Model Name: distilbert-base-uncased-distilled-squad, Tasks: [question-answering],
 Model Name: distilbert-base-uncased-finetuned-sst-2-english, Tasks: [text-classification],
 Model Name: distilbert-base-uncased, Tasks: [fill-mask],
 Model Name: 123abhiALFLKFO/distilbert-base-uncased-finetuned-cola, Tasks: [text-classification]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We want the first one.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have picked a model, let's use the data API to prepare our data</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='It should be mentioned that this is optional, you can always just pass in the string name of a model such as "bert-base-cased"' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Building-TaskDatasets">Building <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a><a class="anchor-link" href="#Building-TaskDatasets"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All of the task-specific high-level data API's (such as <a href="/adaptnlp/training.sequence_classification.html#SequenceClassificationDatasets"><code>SequenceClassificationDatasets</code></a>) all wrap around the <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> class, which is a small wrapper around <code>datasets</code> highly efficient <code>Dataset</code> class.</p>
<p>This integration was valuable because it provides a fast and memory-efficient way to use large datasets with minimal effort.</p>
<p>First let's import the class:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">TaskDatasets</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> class has no class constructors outside the normal one. The reason for this is it takes in raw <code>Datasets</code> and other tokenizer arguments to build from:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TaskDatasets" class="doc_header"><code>class</code> <code>TaskDatasets</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/core.py#L171" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TaskDatasets</code>(<strong><code>train_dset</code></strong>, <strong><code>valid_dset</code></strong>, <strong><code>tokenizer_name</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>tokenize</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>tokenize_func</code></strong>:<code>callable</code>=<em><code>None</code></em>, <strong><code>tokenize_kwargs</code></strong>:<code>dict</code>=<em><code>{}</code></em>, <strong><code>auto_kwargs</code></strong>:<code>dict</code>=<em><code>{}</code></em>, <strong><code>remove_cols</code></strong>:<code>Union</code>[<code>str</code>, <code>List</code>[<code>str</code>]]=<em><code>None</code></em>, <strong><code>label_keys</code></strong>:<code>list</code>=<em><code>['labels']</code></em>)</p>
</blockquote>
<p>A set of datasets for a particular task, with a simple API.</p>
<p>Note: This is the base API, <code>items</code> should be a set of regular text and model-ready labels,
      including label or one-hot encoding being applied.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>train_dset</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em>  <p>A train `Dataset` object</p></li>
</ul>
<ul>
<li><strong><code>valid_dset</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em>  <p>A validation `Dataset` object</p></li>
</ul>
<ul>
<li><strong><code>tokenizer_name</code></strong> : <em><code>&lt;class 'str'&gt;</code></em>, <em>optional</em> <p>The string name of a `HuggingFace` tokenizer or model. If `None`, will not tokenize the dataset.</p></li>
</ul>
<ul>
<li><strong><code>tokenize</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em>  <p>Whether to tokenize the dataset immediatly</p></li>
</ul>
<ul>
<li><strong><code>tokenize_func</code></strong> : <em><code>&lt;built-in function callable&gt;</code></em>, <em>optional</em>   <p>A function to tokenize an item with</p></li>
</ul>
<ul>
<li><strong><code>tokenize_kwargs</code></strong> : <em><code>&lt;class 'dict'&gt;</code></em>, <em>optional</em>   <p>Some kwargs for when we call the tokenizer</p></li>
</ul>
<ul>
<li><strong><code>auto_kwargs</code></strong> : <em><code>&lt;class 'dict'&gt;</code></em>, <em>optional</em>   <p>Some kwargs when calling `AutoTokenizer.from_pretrained`</p></li>
</ul>
<ul>
<li><strong><code>remove_cols</code></strong> : <em><code>typing.Union[str, typing.List[str]]</code></em>, <em>optional</em>  <p>What columns to remove</p></li>
</ul>
<ul>
<li><strong><code>label_keys</code></strong> : <em><code>&lt;class 'list'&gt;</code></em>, <em>optional</em>    <p>The keys in each item that relate to the label (such as `labels`)</p></li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Anything you would normally pass to the tokenizer call (such as <code>max_length</code>, <code>padding</code>) should go in <code>tokenize_kwargs</code>, and anything going to the <code>AutoTokenizer.from_pretrained</code> constructor should be passed to the <code>auto_kwargs</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-Tokenization-Function-and-Finishing-our-TaskDatasets">Custom Tokenization Function and Finishing our <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a><a class="anchor-link" href="#Custom-Tokenization-Function-and-Finishing-our-TaskDatasets"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You may notice there is an extra step here: We need to pass in a <code>tokenize_func</code>. In the other tutorials we used a very basic tokenizing function, and this has a default for that as well.</p>
<p>However given our dataset, we need to implement our own tokenization function.</p>
<p>To do so, your function must take in an <code>item</code>, a <code>tokenizer</code>, and <code>tokenize_kwargs</code>. It should be noted that <strong>you do not have to declare any of these</strong>. All of them are attributes that the <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> has access to, and will be passed to this function implicitly.</p>
<p>What you need to declare is <em>how</em> you want the tokenizer applied.</p>
<p>In our case we have two separate sentences that need to be tokenized at once. These texts live in that dictionary we saw earlier at the keys <code>sentence1</code> and <code>sentence2</code>.</p>
<p>Let's write that function:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">tok_func</span><span class="p">(</span>
    <span class="n">item</span><span class="p">,</span> <span class="c1"># A single item in the dataset</span>
    <span class="n">tokenizer</span><span class="p">,</span> <span class="c1"># The implicit tokenizer that `TaskDatasets` has access to</span>
    <span class="n">tokenize_kwargs</span><span class="p">,</span> <span class="c1"># Key word arguments passed into the constructor of `TaskDatasets`</span>
<span class="p">):</span>
    <span class="s2">&quot;A basic tokenization function for two items&quot;</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;sentence1&#39;</span><span class="p">],</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;sentence2&#39;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">tokenize_kwargs</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Along with building our own tokenize function, we need to tell <code>Datasets</code> what columns to drop when we pull an item from our dataset.</p>
<p>These are synonymous with <code>Datasets</code> <code>remove_cols</code>.</p>
<p>In our problem this includes the <code>sentence1</code>, <code>sentence2</code>, and <code>idx</code> keys, as our tokenized input gets put into a <code>text</code> key:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">remove_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentence1&#39;</span><span class="p">,</span> <span class="s1">&#39;sentence2&#39;</span><span class="p">,</span> <span class="s1">&#39;idx&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally we'll declare some arguments for our tokenize function, specifically ensuring our max length is reasonable and that we should pad our samples to that length:
{% include note.html content='These vary problem to problem. You should look at your specific model and dataset to judge what a proper max length and padding should be. AdaptNLP does its best to use a decent default, but it may not work for every problem' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tokenize_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max_length&#39;</span><span class="p">:</span><span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's build our <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> now, passing in everything we built:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">TaskDatasets</span><span class="p">(</span>
    <span class="n">train_dset</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="c1"># Our training `Dataset`</span>
    <span class="n">valid_dset</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">],</span> <span class="c1"># Our validation `Dataset`</span>
    <span class="n">tokenizer_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="c1"># The name of our model</span>
    <span class="n">tokenize_kwargs</span> <span class="o">=</span> <span class="n">tokenize_kwargs</span><span class="p">,</span> <span class="c1"># The tokenizer kwargs</span>
    <span class="n">tokenize_func</span> <span class="o">=</span> <span class="n">tok_func</span><span class="p">,</span> <span class="c1"># The tokenization function</span>
    <span class="n">remove_cols</span> <span class="o">=</span> <span class="n">remove_cols</span> <span class="c1"># The columns to remove after tokenizing our input</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You may be wondering why we use the <a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a> class, this is a convience wrapper around much of the functions and tasks you need to call when using <code>datasets</code>'s <code>Dataset</code> class, and there are a few special behaviors to quickly build working <a href="/adaptnlp/training.core.html#AdaptiveDataLoaders"><code>AdaptiveDataLoaders</code></a> as well.</p>
<p>Let's build these <a href="/adaptnlp/training.core.html#AdaptiveDataLoaders"><code>AdaptiveDataLoaders</code></a>, which are just fastai's <code>DataLoaders</code> class, but it overrides a few functions to have it work nicely with HuggingFace's <code>Dataset</code> class</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TaskDatasets.dataloaders" class="doc_header"><code>TaskDatasets.dataloaders</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/core.py#L252" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TaskDatasets.dataloaders</code>(<strong><code>batch_size</code></strong>:<code>int</code>=<em><code>8</code></em>, <strong><code>shuffle_train</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>collate_fn</code></strong>:<code>callable</code>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Creates <code>DataLoaders</code> from the dataset</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>batch_size</code></strong> : <em><code>&lt;class 'int'&gt;</code></em>, <em>optional</em> <p>A batch size</p></li>
</ul>
<ul>
<li><strong><code>shuffle_train</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em> <p>Whether to shuffle the training dataset</p></li>
</ul>
<ul>
<li><strong><code>collate_fn</code></strong> : <em><code>&lt;built-in function callable&gt;</code></em>, <em>optional</em>  <p>A custom collation function</p></li>
</ul>
<ul>
<li><p><strong><code>path</code></strong> : <em><code>&lt;class 'str'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>device</code></strong> : <em><code>&lt;class 'NoneType'&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To build our <code>DataLoaders</code>, can call <code>.dataloaders</code>, specifying our batch size and a collate function to use. In our case we will collate with the <code>DataCollatorWithPadding</code> class out of <code>transformers</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">DataCollatorWithPadding</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">DataCollatorWithPadding</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">dsets</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, let's view a batch of data with the <code>show_batch</code> function:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Input</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>the government said firstenergy nuclear determined that a contractor had established an unprotected high - speed computer connection to its corporate network that allowed the " slammer " infection to spread internally. it said firstenergy determined that a contractor had established an unprotected computer connection to its corporate network that allowed the so - called ` ` slammer'' worm to spread internally.</td>
      <td>tensor(1)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>that failure to act contributed to september the 11th and the failure to act today continues ( to put ) americans in a vulnerable circumstance, " graham said. " that failure to act contributed to september 11 and the failure to act today continues [ to put ] americans in a vulnerable circumstance, " said graham.</td>
      <td>tensor(1)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>the companies said " it was not our intention to target or offend any group or persons or to incite hatred or violence. " " in creating the game, it was not our intention to target or offend any group or persons or to incite hatred or violence against such groups persons. "</td>
      <td>tensor(1)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>the 4th u. s. circuit court of appeals has unsealed a heavily edited transcript of the june 3 court session where classified evidence was discussed out of public earshot. the 4th u. s. circuit court of appeals in richmond, va., released the edited transcript of a closed hearing june 3, which followed a public proceeding.</td>
      <td>tensor(0)</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since this isn't a pre-built <code>*TaskDatasets</code> object, the <code>show_batch</code> looks a little plain, but it gets across exactly what you would need to see.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next let's build a <code>Tuner</code> and train our model</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Building-a-Tuner">Building a <code>Tuner</code><a class="anchor-link" href="#Building-a-Tuner"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we need to build a compatible <code>Tuner</code> for our problem. These tuners contain good defaults for our problem space, including loss functions and metrics.</p>
<p>First let's import the <a href="/adaptnlp/training.sequence_classification.html#SequenceClassificationTuner"><code>SequenceClassificationTuner</code></a> and view it's documentation</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">SequenceClassificationTuner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SequenceClassificationTuner" class="doc_header"><code>class</code> <code>SequenceClassificationTuner</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/sequence_classification.py#L222" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SequenceClassificationTuner</code>(<strong><code>dls</code></strong>:<code>DataLoaders</code>, <strong><code>model_name</code></strong>:<code>str</code>, <strong><code>tokenizer</code></strong>=<em><code>None</code></em>, <strong><code>loss_func</code></strong>=<em><code>CrossEntropyLoss()</code></em>, <strong><code>metrics</code></strong>=<em><code>[&lt;function accuracy at 0x7fbce09a0820&gt;, &lt;fastai.metrics.AccumMetric object at 0x7fbce0766370&gt;]</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>additional_cbs</code></strong>=<em><code>None</code></em>, <strong><code>expose_fastai_api</code></strong>=<em><code>False</code></em>, <strong><code>num_classes</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/adaptnlp/training.core.html#AdaptiveTuner"><code>AdaptiveTuner</code></a></p>
</blockquote>
<p>An <a href="/adaptnlp/training.core.html#AdaptiveTuner"><code>AdaptiveTuner</code></a> with good defaults for Sequence Classification tasks</p>
<p><strong>Valid kwargs and defaults:</strong></p>
<ul>
<li><code>lr</code>:float = 0.001</li>
<li><code>splitter</code>:function = <code>trainable_params</code></li>
<li><code>cbs</code>:list = None</li>
<li><code>path</code>:Path = None</li>
<li><code>model_dir</code>:Path = 'models'</li>
<li><code>wd</code>:float = None</li>
<li><code>wd_bn_bias</code>:bool = False</li>
<li><code>train_bn</code>:bool = True</li>
<li><code>moms</code>: tuple(float) = (0.95, 0.85, 0.95)</li>
</ul>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>dls</code></strong> : <em><code>&lt;class 'fastai.data.core.DataLoaders'&gt;</code></em>   <p>A set of DataLoaders</p></li>
</ul>
<ul>
<li><strong><code>model_name</code></strong> : <em><code>&lt;class 'str'&gt;</code></em> <p>A HuggingFace model</p></li>
</ul>
<ul>
<li><strong><code>tokenizer</code></strong> : <em><code>&lt;class 'NoneType'&gt;</code></em>, <em>optional</em> <p>A HuggingFace tokenizer</p></li>
</ul>
<ul>
<li><strong><code>loss_func</code></strong> : <em><code>&lt;class 'fastai.losses.CrossEntropyLossFlat'&gt;</code></em>, <em>optional</em>   <p>A loss function</p></li>
</ul>
<ul>
<li><strong><code>metrics</code></strong> : <em><code>&lt;class 'list'&gt;</code></em>, <em>optional</em>   <p>Metrics to monitor the training with</p></li>
</ul>
<ul>
<li><strong><code>opt_func</code></strong> : <em><code>&lt;class 'function'&gt;</code></em>, <em>optional</em>  <p>A fastai or torch Optimizer</p></li>
</ul>
<ul>
<li><strong><code>additional_cbs</code></strong> : <em><code>&lt;class 'NoneType'&gt;</code></em>, <em>optional</em>    <p>Additional Callbacks to have always tied to the Tuner,</p></li>
</ul>
<ul>
<li><strong><code>expose_fastai_api</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em> <p>Whether to expose the fastai API</p></li>
</ul>
<ul>
<li><strong><code>num_classes</code></strong> : <em><code>&lt;class 'int'&gt;</code></em>, <em>optional</em>    <p>The number of classes</p></li>
</ul>
<ul>
<li><strong><code>kwargs</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em></li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we'll pass in our <code>DataLoaders</code>, the name of our model, and since we are using raw <code>Datasets</code>, the number of classes we have. In our case this is two.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='If you are not using the data API (<a href="/adaptnlp/training.core.html#TaskDatasets"><code>TaskDatasets</code></a>, <a href="/adaptnlp/training.sequence_classification.html#SequenceClassificationDatasets"><code>SequenceClassificationDatasets</code></a>, etc), you need to pass in the tokenizer to the constructor as well with <code>tokenizer=tokenizer</code>' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span> <span class="o">=</span> <span class="n">SequenceClassificationTuner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Some weights of the model checkpoint at bert-base-uncased were not used when initializing BertForSequenceClassification: [&#39;cls.predictions.transform.LayerNorm.weight&#39;, &#39;cls.predictions.decoder.weight&#39;, &#39;cls.predictions.bias&#39;, &#39;cls.predictions.transform.dense.bias&#39;, &#39;cls.predictions.transform.LayerNorm.bias&#39;, &#39;cls.seq_relationship.weight&#39;, &#39;cls.predictions.transform.dense.weight&#39;, &#39;cls.seq_relationship.bias&#39;]
- This IS expected if you are initializing BertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing BertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at bert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By default we can see that it used <code>CrossEntropyLoss</code> as our loss function, and both <code>accuracy</code> and <code>F1Score</code> as our metrics:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">loss_func</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FlattenedLoss of CrossEntropyLoss()</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tuner</span><span class="o">.</span><span class="n">metrics</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>accuracy
f1_score
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is also possible to define your own metrics, these stem from <a href="https://docs.fast.ai/metrics">fastai</a>.</p>
<p>To do so, write a function that takes an input and an output, and performs an operation. For example, we will write our own <code>accuracy</code> metric:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">ourAccuracy</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="s2">&quot;A simplified accuracy metric that doesn&#39;t flatten&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">inp</span> <span class="o">==</span> <span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then we pass it into the constructor:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span> <span class="o">=</span> <span class="n">SequenceClassificationTuner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">ourAccuracy</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Some weights of the model checkpoint at bert-base-uncased were not used when initializing BertForSequenceClassification: [&#39;cls.predictions.transform.LayerNorm.weight&#39;, &#39;cls.predictions.decoder.weight&#39;, &#39;cls.predictions.bias&#39;, &#39;cls.predictions.transform.dense.bias&#39;, &#39;cls.predictions.transform.LayerNorm.bias&#39;, &#39;cls.seq_relationship.weight&#39;, &#39;cls.predictions.transform.dense.weight&#39;, &#39;cls.seq_relationship.bias&#39;]
- This IS expected if you are initializing BertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing BertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at bert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we look at the metrics, you can see that now it is just <code>ourAccuracy</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;ourAccuracy&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For this tutorial, we will revert it back to the defaults:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span> <span class="o">=</span> <span class="n">SequenceClassificationTuner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Some weights of the model checkpoint at bert-base-uncased were not used when initializing BertForSequenceClassification: [&#39;cls.predictions.transform.LayerNorm.weight&#39;, &#39;cls.predictions.decoder.weight&#39;, &#39;cls.predictions.bias&#39;, &#39;cls.predictions.transform.dense.bias&#39;, &#39;cls.predictions.transform.LayerNorm.bias&#39;, &#39;cls.seq_relationship.weight&#39;, &#39;cls.predictions.transform.dense.weight&#39;, &#39;cls.seq_relationship.bias&#39;]
- This IS expected if you are initializing BertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing BertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at bert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally we just need to train our model!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fine-Tuning">Fine-Tuning<a class="anchor-link" href="#Fine-Tuning"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To fine-tune, AdaptNLP's tuner class provides only a few functions to work with. The important ones are the <code>tune</code> and <code>lr_find</code> class.</p>
<p>As the <code>Tuner</code> uses <code>fastai</code> under the hood, <code>lr_find</code> calls fastai's Learning Rate Finder to help us pick a learning rate. Let's do that now:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="AdaptiveTuner.lr_find" class="doc_header"><code>AdaptiveTuner.lr_find</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/core.py#L413" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>AdaptiveTuner.lr_find</code>(<strong><code>start_lr</code></strong>=<em><code>1e-07</code></em>, <strong><code>end_lr</code></strong>=<em><code>10</code></em>, <strong><code>num_it</code></strong>=<em><code>100</code></em>, <strong><code>stop_div</code></strong>=<em><code>True</code></em>, <strong><code>show_plot</code></strong>=<em><code>True</code></em>, <strong><code>suggest_funcs</code></strong>=<em><code>valley</code></em>)</p>
</blockquote>
<p>Runs fastai's <code>LR Finder</code></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>start_lr</code></strong> : <em><code>&lt;class 'float'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>end_lr</code></strong> : <em><code>&lt;class 'int'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>num_it</code></strong> : <em><code>&lt;class 'int'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>stop_div</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>show_plot</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>suggest_funcs</code></strong> : <em><code>&lt;class 'function'&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/opt/venv/lib/python3.8/site-packages/fastai/callback/schedule.py:270: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &#34;ro&#34; (-&gt; color=&#39;r&#39;). The keyword argument will take precedence.
  ax.plot(val, idx, &#39;ro&#39;, label=nm, c=color)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(valley=7.585775892948732e-05)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It recommends a learning rate of around 2e-4, however a steeper slope can be found around 5e-5 so we will use that.
{% include note.html content='Reading the LR Finder is somewhat of an art. The <code>valley</code> method is one of the most reliable ones, but also try and figure out an intuition towards finding a learning rate as you go as well.' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="mf">5e-5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's look at the documentation for <code>tune</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="AdaptiveTuner.tune" class="doc_header"><code>AdaptiveTuner.tune</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/core.py#L399" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>AdaptiveTuner.tune</code>(<strong><code>epochs</code></strong>:<code>int</code>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>None</code></em>, <strong><code>strategy</code></strong>:<code>Strategy</code>=<em><code>'fit_one_cycle'</code></em>, <strong><code>callbacks</code></strong>:<code>list</code>=<em><code>[]</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Fine tune <code>self.model</code> for <code>epochs</code> with an <code>lr</code> and <code>strategy</code></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>epochs</code></strong> : <em><code>&lt;class 'int'&gt;</code></em> <p>Number of iterations to train for</p></li>
</ul>
<ul>
<li><strong><code>lr</code></strong> : <em><code>&lt;class 'float'&gt;</code></em>, <em>optional</em>   <p>If None, finds a new learning rate and uses suggestion_method</p></li>
</ul>
<ul>
<li><strong><code>strategy</code></strong> : <em><code>&lt;class 'fastcore.basics.Strategy'&gt;</code></em>, <em>optional</em>  <p>A fitting method</p></li>
</ul>
<ul>
<li><strong><code>callbacks</code></strong> : <em><code>&lt;class 'list'&gt;</code></em>, <em>optional</em> <p>Extra fastai Callbacks</p></li>
</ul>
<ul>
<li><strong><code>kwargs</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em></li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can pass in a number of epochs, a learning rate, a strategy, and additional fastai callbacks to call.</p>
<p>Valid strategies live in the <code>Strategy</code> namespace class, and consist of:</p>
<ul>
<li>OneCycle (Also called the <a href="https://docs.fast.ai/callback.schedule.html#Learner.fit_one_cycle">One-Cycle Policy</a>)</li>
<li><a href="https://docs.fast.ai/callback.schedule.html#Learner.fit_flat_cos">CosineAnnealing</a></li>
<li><a href="https://docs.fast.ai/callback.schedule.html#Learner.fit_sgdr">SGDR</a></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">Strategy</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this tutorial we will train with the One-Cycle policy, as currently it is one of the best schedulers to use.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">tune</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">Strategy</span><span class="o">.</span><span class="n">OneCycle</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>f1_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.505338</td>
      <td>0.372632</td>
      <td>0.835784</td>
      <td>0.876611</td>
      <td>01:19</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.286884</td>
      <td>0.375253</td>
      <td>0.855392</td>
      <td>0.900840</td>
      <td>01:20</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.058951</td>
      <td>0.439049</td>
      <td>0.860294</td>
      <td>0.903226</td>
      <td>01:20</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Saving-Model">Saving Model<a class="anchor-link" href="#Saving-Model"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have a trained model, let's save those weights away.</p>
<p>Calling <code>tuner.save</code> will save both the model and the tokenizer in the same format as how HuggingFace does:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="AdaptiveTuner.save" class="doc_header"><code>AdaptiveTuner.save</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/core.py#L421" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>AdaptiveTuner.save</code>(<strong><code>save_directory</code></strong>)</p>
</blockquote>
<p>Save a pretrained model to a <code>save_directory</code></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>save_directory</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em>  <p>A folder to save our model to</p></li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;good_model&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_11201/1955740056.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>tuner<span class="ansi-blue-fg">.</span>save<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;good_model&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/home/jovyan/adaptnlp/adaptnlp/training/core.py</span> in <span class="ansi-cyan-fg">save</span><span class="ansi-blue-fg">(self, save_directory)</span>
<span class="ansi-green-intense-fg ansi-bold">    400</span>     ):
<span class="ansi-green-intense-fg ansi-bold">    401</span>         <span class="ansi-blue-fg">&#34;Save a pretrained model to a `save_directory`&#34;</span>
<span class="ansi-green-fg">--&gt; 402</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">if</span> rank_distrib<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-red-fg"># Don&#39;t save if child proc</span>
<span class="ansi-green-intense-fg ansi-bold">    403</span>         self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">.</span>save_pretrained<span class="ansi-blue-fg">(</span>save_directory<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    404</span>         self<span class="ansi-blue-fg">.</span>tokenizer<span class="ansi-blue-fg">.</span>save_pretrained<span class="ansi-blue-fg">(</span>save_directory<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">NameError</span>: name &#39;rank_distrib&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Performing-Inference">Performing Inference<a class="anchor-link" href="#Performing-Inference"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are two ways to get predictions, the first is with the <code>.predict</code> method in our <code>tuner</code>. This is great for if you just finished training and want to see how your model performs on some new data!
The other method is with AdaptNLP's inference API, which we will show afterwards</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="In-Tuner">In Tuner<a class="anchor-link" href="#In-Tuner"> </a></h3><p>First let's write a sentence to test with</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s1">&#39;Amrozi accused his brother , whom he called &quot; the witness &quot; , of deliberately distorting his evidence . Referring to him as only &quot; the witness &quot; , Amrozi accused his brother of deliberately distorting his evidence .&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then predict with it:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="SequenceClassificationTuner.predict" class="doc_header"><code>SequenceClassificationTuner.predict</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/training/sequence_classification.py#L272" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>SequenceClassificationTuner.predict</code>(<strong><code>text</code></strong>:<code>Union</code>[<code>List</code>[<code>str</code>], <code>str</code>], <strong><code>bs</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>detail_level</code></strong>:<code>DetailLevel</code>=<em><code>'low'</code></em>, <strong><code>class_names</code></strong>:<code>list</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Predict some <code>text</code> for sequence classification with the currently loaded model</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong><code>text</code></strong> : <em><code>typing.Union[typing.List[str], str]</code></em> <p>Some text or list of texts to do inference with</p></li>
</ul>
<ul>
<li><strong><code>bs</code></strong> : <em><code>&lt;class 'int'&gt;</code></em>, <em>optional</em> <p>A batch size to use for multiple texts</p></li>
</ul>
<ul>
<li><strong><code>detail_level</code></strong> : <em><code>&lt;class 'fastcore.basics.DetailLevel'&gt;</code></em>, <em>optional</em>   <p>A detail level to return on the predictions</p></li>
</ul>
<ul>
<li><strong><code>class_names</code></strong> : <em><code>&lt;class 'list'&gt;</code></em>, <em>optional</em>   <p>A list of labels</p></li>
</ul>
<p><strong>Returns</strong>:</p>
<ul>
<li><em><code>&lt;class 'dict'&gt;</code></em>   <p>A dictionary of filtered predictions</p></li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You'll notice it says <code>LABEL_1</code>. We did not build with the <code>Datasets</code> wrapper API's, so currently they do not have a vocabulary to work off of.</p>
<p>Let's pass in a vocabulary of <code>not_equivalent</code> and <code>equivalent</code> to work with:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;not_equivalent&#39;</span><span class="p">,</span> <span class="s1">&#39;equivalent&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tuner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can see it gave us much more readable results!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="With-the-Inference-API">With the Inference API<a class="anchor-link" href="#With-the-Inference-API"> </a></h3><p>Next we will use the <a href="/adaptnlp/sequence_classification.html#EasySequenceClassifier"><code>EasySequenceClassifier</code></a> class, which AdaptNLP offers:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">EasySequenceClassifier</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We simply construct the class:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">classifier</span> <span class="o">=</span> <span class="n">EasySequenceClassifier</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And call the <code>tag_text</code> method, passing in the sentence, the location of our saved model, and some names for our classes.</p>
<p>Similarly here, we can pass in our own vocabulary to use. Let's do that:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">classifier</span><span class="o">.</span><span class="n">tag_text</span><span class="p">(</span>
    <span class="n">sentence</span><span class="p">,</span>
    <span class="n">model_name_or_path</span><span class="o">=</span><span class="s1">&#39;good_model&#39;</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">names</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And we got the exact same output and probabilities!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are also different levels of predictions we can return (which is also the same with our earlier <code>predict</code> call).</p>
<p>These live in a namespace <code>DetailLevel</code> class, with a few examples below:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">adaptnlp</span> <span class="kn">import</span> <span class="n">DetailLevel</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DetailLevel</span><span class="o">.</span><span class="n">Low</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>While some Easy modules will not return different items at each level, most will return only a few specific outputs at the Low level, and everything possible at the High level:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">classifier</span><span class="o">.</span><span class="n">tag_text</span><span class="p">(</span>
    <span class="n">sentence</span><span class="p">,</span>
    <span class="n">model_name_or_path</span> <span class="o">=</span> <span class="s1">&#39;good_model&#39;</span><span class="p">,</span>
    <span class="n">detail_level</span><span class="o">=</span><span class="n">DetailLevel</span><span class="o">.</span><span class="n">Low</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">names</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">classifier</span><span class="o">.</span><span class="n">tag_text</span><span class="p">(</span>
    <span class="n">sentence</span><span class="p">,</span>
    <span class="n">model_name_or_path</span> <span class="o">=</span> <span class="s1">&#39;good_model&#39;</span><span class="p">,</span>
    <span class="n">detail_level</span><span class="o">=</span><span class="n">DetailLevel</span><span class="o">.</span><span class="n">Medium</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">names</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">classifier</span><span class="o">.</span><span class="n">tag_text</span><span class="p">(</span>
    <span class="n">sentence</span><span class="p">,</span>
    <span class="n">model_name_or_path</span> <span class="o">=</span> <span class="s1">&#39;good_model&#39;</span><span class="p">,</span>
    <span class="n">detail_level</span><span class="o">=</span><span class="n">DetailLevel</span><span class="o">.</span><span class="n">High</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="n">names</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

