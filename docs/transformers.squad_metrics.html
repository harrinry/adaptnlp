---

title: Transformers Squad Metrics


keywords: fastai
sidebar: home_sidebar

summary: "Squad Metrics from the Transformers library"
description: "Squad Metrics from the Transformers library"
nb_path: "nbs/13a_transformers.squad_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/13a_transformers.squad_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="normalize_answer" class="doc_header"><code>normalize_answer</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>normalize_answer</code>(<strong><code>s</code></strong>)</p>
</blockquote>
<p>Lower text and remove punctuation, articles and extra whitespace.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_tokens" class="doc_header"><code>get_tokens</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L54" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_tokens</code>(<strong><code>s</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_exact" class="doc_header"><code>compute_exact</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L60" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_exact</code>(<strong><code>a_gold</code></strong>, <strong><code>a_pred</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_f1" class="doc_header"><code>compute_f1</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_f1</code>(<strong><code>a_gold</code></strong>, <strong><code>a_pred</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_raw_scores" class="doc_header"><code>get_raw_scores</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L80" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_raw_scores</code>(<strong><code>examples</code></strong>, <strong><code>preds</code></strong>)</p>
</blockquote>
<p>Computes the exact and f1 scores from the examples and the model predictions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="apply_no_ans_threshold" class="doc_header"><code>apply_no_ans_threshold</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L110" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>apply_no_ans_threshold</code>(<strong><code>scores</code></strong>, <strong><code>na_probs</code></strong>, <strong><code>qid_to_has_ans</code></strong>, <strong><code>na_prob_thresh</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_eval_dict" class="doc_header"><code>make_eval_dict</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L121" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_eval_dict</code>(<strong><code>exact_scores</code></strong>, <strong><code>f1_scores</code></strong>, <strong><code>qid_list</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="merge_eval" class="doc_header"><code>merge_eval</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L142" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>merge_eval</code>(<strong><code>main_eval</code></strong>, <strong><code>new_eval</code></strong>, <strong><code>prefix</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_best_thresh_v2" class="doc_header"><code>find_best_thresh_v2</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L147" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_best_thresh_v2</code>(<strong><code>preds</code></strong>, <strong><code>scores</code></strong>, <strong><code>na_probs</code></strong>, <strong><code>qid_to_has_ans</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_all_best_thresh_v2" class="doc_header"><code>find_all_best_thresh_v2</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L185" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_all_best_thresh_v2</code>(<strong><code>main_eval</code></strong>, <strong><code>preds</code></strong>, <strong><code>exact_raw</code></strong>, <strong><code>f1_raw</code></strong>, <strong><code>na_probs</code></strong>, <strong><code>qid_to_has_ans</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_best_thresh" class="doc_header"><code>find_best_thresh</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L202" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_best_thresh</code>(<strong><code>preds</code></strong>, <strong><code>scores</code></strong>, <strong><code>na_probs</code></strong>, <strong><code>qid_to_has_ans</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_all_best_thresh" class="doc_header"><code>find_all_best_thresh</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L225" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_all_best_thresh</code>(<strong><code>main_eval</code></strong>, <strong><code>preds</code></strong>, <strong><code>exact_raw</code></strong>, <strong><code>f1_raw</code></strong>, <strong><code>na_probs</code></strong>, <strong><code>qid_to_has_ans</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="squad_evaluate" class="doc_header"><code>squad_evaluate</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L237" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>squad_evaluate</code>(<strong><code>examples</code></strong>, <strong><code>preds</code></strong>, <strong><code>no_answer_probs</code></strong>=<em><code>None</code></em>, <strong><code>no_answer_probability_threshold</code></strong>=<em><code>1.0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_final_text" class="doc_header"><code>get_final_text</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L284" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_final_text</code>(<strong><code>pred_text</code></strong>, <strong><code>orig_text</code></strong>, <strong><code>do_lower_case</code></strong>, <strong><code>verbose_logging</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Project the tokenized prediction back to the original text.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_predictions_logits" class="doc_header"><code>compute_predictions_logits</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L417" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_predictions_logits</code>(<strong><code>all_examples</code></strong>, <strong><code>all_features</code></strong>, <strong><code>all_results</code></strong>, <strong><code>n_best_size</code></strong>, <strong><code>max_answer_length</code></strong>, <strong><code>do_lower_case</code></strong>, <strong><code>verbose_logging</code></strong>, <strong><code>version_2_with_negative</code></strong>, <strong><code>null_score_diff_threshold</code></strong>, <strong><code>tokenizer</code></strong>, <strong><code>output_prediction_file</code></strong>=<em><code>None</code></em>, <strong><code>output_nbest_file</code></strong>=<em><code>None</code></em>, <strong><code>output_null_log_odds_file</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="compute_predictions_log_probs" class="doc_header"><code>compute_predictions_log_probs</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/transformers/squad_metrics.py#L662" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>compute_predictions_log_probs</code>(<strong><code>all_examples</code></strong>, <strong><code>all_features</code></strong>, <strong><code>all_results</code></strong>, <strong><code>n_best_size</code></strong>, <strong><code>max_answer_length</code></strong>, <strong><code>start_n_top</code></strong>, <strong><code>end_n_top</code></strong>, <strong><code>version_2_with_negative</code></strong>, <strong><code>tokenizer</code></strong>, <strong><code>verbose_logging</code></strong>, <strong><code>output_prediction_file</code></strong>=<em><code>None</code></em>, <strong><code>output_nbest_file</code></strong>=<em><code>None</code></em>, <strong><code>output_null_log_odds_file</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>XLNet write prediction logic (more complex than Bert's).
Write final predictions to the json file and log-odds of null if needed.
Requires utils_squad_evaluate.py</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

