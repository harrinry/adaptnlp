---

title: File Utilities


keywords: fastai
sidebar: home_sidebar

summary: "Utilities for working with a local dataset cache, adapted from AllenNLP"
description: "Utilities for working with a local dataset cache, adapted from AllenNLP"
nb_path: "nbs/00_file_utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_file_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/mnt/d/lib/python3.7/site-packages/torch/cuda/__init__.py:52: UserWarning: CUDA initialization: Found no NVIDIA driver on your system. Please check that you have an NVIDIA GPU and installed a driver from http://www.nvidia.com/Download/index.aspx (Triggered internally at  /pytorch/c10/cuda/CUDAFunctions.cpp:100.)
  return torch._C._cuda_getDeviceCount() &gt; 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="url_to_filename" class="doc_header"><code>url_to_filename</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>url_to_filename</code>(<strong><code>url</code></strong>:<code>str</code>, <strong><code>etag</code></strong>:<code>str</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Convert <code>url</code> into a hashed filename in a repeatable way.
If <code>etag</code> is specified, append its hash to the url's, delimited
by a period.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="filename_to_url" class="doc_header"><code>filename_to_url</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>filename_to_url</code>(<strong><code>filename</code></strong>:<code>str</code>, <strong><code>cache_dir</code></strong>:<code>str</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return the url and etag (which may be <code>None</code>) stored for <code>filename</code>.
Raise <code>FileNotFoundError</code> if <code>filename</code> or its stored metadata do not exist.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cached_path" class="doc_header"><code>cached_path</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L86" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cached_path</code>(<strong><code>url_or_filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>cache_dir</code></strong>:<code>str</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Given something that might be a URL (or might be a local path),
determine which. If it's a URL, download the file and cache it, and
return the path to the cached file. If it's already a local path,
make sure the file exists and then return the path.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_url_or_existing_file" class="doc_header"><code>is_url_or_existing_file</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L117" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_url_or_existing_file</code>(<strong><code>url_or_filename</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>, <code>NoneType</code>])</p>
</blockquote>
<p>Given something that might be a URL (or might be a local path),
determine check if it's url or an existing file path.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_s3_path" class="doc_header"><code>split_s3_path</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L129" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_s3_path</code>(<strong><code>url</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Split a full s3 path into the bucket name and path.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="s3_request" class="doc_header"><code>s3_request</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L142" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>s3_request</code>(<strong><code>func</code></strong>:<code>Callable</code>)</p>
</blockquote>
<p>Wrapper function for s3 requests in order to create more helpful error
messages.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_s3_resource" class="doc_header"><code>get_s3_resource</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L161" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_s3_resource</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="s3_etag" class="doc_header"><code>s3_etag</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L173" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>s3_etag</code>(<strong><code>url</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Check ETag on S3 object.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="s3_get" class="doc_header"><code>s3_get</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L182" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>s3_get</code>(<strong><code>url</code></strong>:<code>str</code>, <strong><code>temp_file</code></strong>:<code>IO</code>)</p>
</blockquote>
<p>Pull a file directly from S3.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="session_with_backoff" class="doc_header"><code>session_with_backoff</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L190" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>session_with_backoff</code>()</p>
</blockquote>
<p>We ran into an issue where http requests to s3 were timing out,
possibly because we were making too many requests too quickly.
This helper function returns a requests session that has retry-with-backoff
built in.
see stackoverflow.com/questions/23267409/how-to-implement-retry-mechanism-into-python-requests-library</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="http_get" class="doc_header"><code>http_get</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L206" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>http_get</code>(<strong><code>url</code></strong>:<code>str</code>, <strong><code>temp_file</code></strong>:<code>IO</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_from_cache" class="doc_header"><code>get_from_cache</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L219" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_from_cache</code>(<strong><code>url</code></strong>:<code>str</code>, <strong><code>cache_dir</code></strong>:<code>str</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Given a URL, look for the corresponding dataset in the local cache.
If it's not there, download it. Then return the path to the cached file.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_set_from_file" class="doc_header"><code>read_set_from_file</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L281" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_set_from_file</code>(<strong><code>filename</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Extract a de-duped collection (set) of text from a file.
Expected file format is one item per line.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_file_extension" class="doc_header"><code>get_file_extension</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L293" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_file_extension</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>dot</code></strong>=<em><code>True</code></em>, <strong><code>lower</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Tqdm" class="doc_header"><code>class</code> <code>Tqdm</code><a href="https://github.com/novetta/adaptnlp/tree/master/adaptnlp/file_utils.py#L299" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Tqdm</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

